{% extends '_layout_vertical.html.twig' %}

{% block title %}
    Time Grid – {{ scope_label(primary) }} – {{ parent() }}
{% endblock %}

{% block header %}
    {% embed '_embeds/header.html.twig' %}
        {% block header_after %}
            {{ include(('_includes/subnav_stats.html.twig')) }}
        {% endblock %}
    {% endembed %}
{% endblock %}

{% block page_body %}
    <div class="container-xl">

        <twig:Breadcrumbs :items="[
            { label: 'Statistics', path: path('app_data_index') },
            { label: 'Time Grid' }
        ]" />

        <div class="d-flex align-items-center mb-3">
            <h2 class="page-title me-auto">
                {{ scope_label(primary) }}
                {% if base %}
                    <small class="text-muted">
                        &nbsp;compared to {{ scope_label(base) }}
                    </small>
                {% endif %}
            </h2>

            {% set req = app.request.query.all %}
            {% set baseParams = req|merge({
                primaryType: primary.scopeType,
                primaryId: primary.scopeId,
                baseType: base ? base.scopeType : null,
                baseId: base ? base.scopeId : null,
                gran: primary.granularity,
                key: primary.periodKey,
                mode: mode.value
            })|filter(v => v is not null) %}

            <div class="dropdown me-2">
                <button class="btn btn-outline dropdown-toggle" data-bs-toggle="dropdown" type="button">
                    {{ (presets|filter(p => p.value == currentPreset)|first).label ?? 'Default' }}
                </button>
                <div class="dropdown-menu dropdown-menu-end">
                    {% for p in presets %}
                        {% set active = (p.value == currentPreset) %}
                        <a class="dropdown-item {% if active %}active{% endif %}"
                           href="{{ path(app.request.attributes.get('_route'), baseParams|merge({'metrics': p.value})) }}">
                            {{ p.label }}
                        </a>
                    {% endfor %}
                </div>
            </div>

            <twig:GranularitySwitch
                :scope="primary"
                variant="dropdown"
                :showPeriod="true"
                :allowedOptions="['year', 'quarter', 'month', 'week']"
            />
        </div>

        <twig:ChooseScopePicker
            :primary="primary"
            :base="base"
            :mode="mode"
            preset="{{ preset }}"
        />

        <twig:TimeGridChart :columns="columns" :rows="rows" :mode="mode" />

        <twig:TimeGrid
            :columns="columns"
            :rows="rows"
            :mode="mode"
        />

        <twig:TimeScopePager
            :scope="primary"
            variant="full"
        />

    </div>
{% endblock %}
