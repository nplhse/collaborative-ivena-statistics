{# templates/components/HourlyChart.html.twig #}

{# 1) Presets & aktives Preset rein in Twig (keine PHP-Änderung nötig) #}
{% set currentPreset = app.request.query.get('hourly', 'total') %}
{% set presets = [
    {value: 'total', label: 'Total'},
    {value: 'gender', label: 'Gender'},
    {value: 'urgency', label: 'Urgency'},
    {value: 'clinical', label: 'Clinical'},
    {value: 'resources', label: 'Resources'},
] %}

<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title m-0">Hourly Distribution</h3>

        <div class="dropdown">
            <button class="btn btn-outline dropdown-toggle" data-bs-toggle="dropdown" type="button">
                {{ (presets|filter(p => p.value == currentPreset)|first).label ?? 'Total' }}
            </button>
            <div class="dropdown-menu dropdown-menu-end">
                {% for p in presets %}
                    {% set active = (p.value == currentPreset) %}
                    <a class="dropdown-item {% if active %}active{% endif %}"
                       href="{{ path(app.request.attributes.get('_route'), app.request.query.all|merge({hourly: p.value})) }}">
                        {{ p.label }}
                    </a>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if this.series is empty or (this.series|first).data is empty %}
            <div class="empty">
                <div class="empty-icon"><i class="ti ti-chart-line"></i></div>
                <p class="empty-title">No hourly data</p>
                <p class="empty-subtitle text-muted">There are no hourly series for the selected scope/period.</p>
            </div>
        {% else %}
            <div id="{{ this.domId ?: 'chart-hourly' }}" class="position-relative" style="height: {{ this.height }}px"></div>

            <script>
                (function () {
                    var _id     = {{ (this.domId ?: 'chart-hourly')|json_encode|raw }};
                    var _labels = {{ this.labels|json_encode|raw }};
                    var _series = {{ this.series|json_encode|raw }};
                    var _height = {{ this.height|json_encode|raw }};

                    function loadApexOnce() {
                        if (window.ApexCharts) return Promise.resolve();
                        if (window.__apexLoading) return window.__apexLoading;
                        window.__apexLoading = new Promise(function (resolve, reject) {
                            var s = document.createElement('script');
                            s.src = "https://cdn.jsdelivr.net/npm/apexcharts";
                            s.async = true;
                            s.onload = resolve;
                            s.onerror = function(){ reject(new Error("apex_load_failed")); };
                            document.head.appendChild(s);
                        });
                        return window.__apexLoading;
                    }

                    function colorFor(name, idx){
                        var map = {
                            'Total':'var(--tblr-primary)',
                            'Male':'var(--tblr-blue)',
                            'Female':'var(--tblr-pink)',
                            'Diverse':'var(--tblr-indigo)',
                            'Urgency 1':'var(--tblr-red)',
                            'Urgency 2':'var(--tblr-yellow)',
                            'Urgency 3':'var(--tblr-lime)',
                            'Ventilated':'var(--tblr-azure)',
                            'CPR':'var(--tblr-red)',
                            'Shock':'var(--tblr-grape)',
                            'Pregnant':'var(--tblr-violet)',
                            'With Physician':'var(--tblr-teal)',
                            'Infectious':'var(--tblr-rose)',
                            'Cathlab required':'var(--tblr-cyan)',
                            'Resus required':'var(--tblr-green)'
                        };
                        var palette = [
                            'var(--tblr-primary)','var(--tblr-green)','var(--tblr-yellow)',
                            'var(--tblr-azure)','var(--tblr-orange)','var(--tblr-pink)',
                            'var(--tblr-indigo)','var(--tblr-lime)','var(--tblr-cyan)'
                        ];
                        return map[name] || palette[idx % palette.length];
                    }

                    function render() {
                        var el = document.getElementById(_id);
                        if (!el || el.dataset.rendered === "1") return;

                        var options = {
                            chart: {
                                type: "line",
                                height: _height,
                                parentHeightOffset: 0,
                                fontFamily: 'inherit',
                                toolbar: { show: false },
                                animations: { enabled: false }
                            },
                            stroke: { width: 2, curve: "straight", lineCap: "round" },
                            dataLabels: { enabled: false },
                            grid: { strokeDashArray: 4, padding: { top: -20, right: 0, left: -4, bottom: -4 } },
                            xaxis: {
                                categories: _labels,
                                labels: { show: true },
                                tooltip: { enabled: false }
                            },
                            yaxis: { labels: { padding: 4 } },
                            tooltip: { theme: 'dark', shared: true, intersect: false },
                            legend: {
                                show: true, position: 'bottom', offsetY: 12,
                                markers: { width: 10, height: 10, radius: 100 },
                                itemMargin: { horizontal: 8, vertical: 8 }
                            },
                            colors: _series.map(function(s,i){ return colorFor(s.name, i); }),
                            series: _series
                        };

                        loadApexOnce().then(function(){
                            var chart = new ApexCharts(el, options);
                            chart.render();
                            el.dataset.rendered = "1";
                            el.__chart = chart;
                        });
                    }

                    if (window.Turbo) {
                        document.addEventListener('turbo:load', render, { once: true });
                    } else if (document.readyState === 'complete' || document.readyState === 'interactive') {
                        render();
                    } else {
                        document.addEventListener('DOMContentLoaded', render, { once: true });
                    }
                })();
            </script>
        {% endif %}
    </div>
</div>
