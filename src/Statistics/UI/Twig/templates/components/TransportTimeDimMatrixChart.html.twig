<div class="card mb-3">
    <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
        <h3 class="card-title mb-0">
            {{ this.dimLabel() }} â€“ top {{ this.limit }} by transport time
            {% if this.view == 'pct' %}
                <span class="badge bg-primary-lt ms-2">Share per dimension</span>
            {% endif %}
        </h3>

        <div class="d-flex align-items-center gap-2 ms-auto">
            {# Mode toggle: Counts / Share #}
            <div class="btn-group" role="group" aria-label="Mode">
                <a class="btn btn-outline {% if this.view == 'int' %}active{% endif %}"
                   href="{{ this.viewUrl('int') }}">
                    Counts
                </a>
                <a class="btn btn-outline {% if this.view == 'pct' %}active{% endif %}"
                   href="{{ this.viewUrl('pct') }}">
                    Share
                </a>
            </div>

            {# Limit toggle: Top 5 / Top 10 #}
            <div class="btn-group" role="group" aria-label="Limit">
                <a class="btn btn-outline {% if this.limit == 5 %}active{% endif %}"
                   href="{{ this.limitUrl(5) }}">
                    Top 5
                </a>
                <a class="btn btn-outline {% if this.limit == 10 %}active{% endif %}"
                   href="{{ this.limitUrl(10) }}">
                    Top 10
                </a>
            </div>
        </div>
    </div>

    <div class="card-body">
        {% if not this.hasData() %}
            <div class="empty">
                <div class="empty-icon"><i class="ti ti-chart-bar"></i></div>
                <p class="empty-title">No data</p>
                <p class="empty-subtitle text-muted">
                    There are no dimension series for the selected scope/period.
                </p>
            </div>
        {% else %}
            <div id="{{ this.domId }}" class="position-relative" style="height: {{ this.height }}px"></div>

            <script>
                (function () {
                    var _id     = {{ this.domId|json_encode|raw }};
                    var _labels = {{ this.labels|json_encode|raw }};
                    var _series = {{ this.series|json_encode|raw }};
                    var _height = {{ this.height|json_encode|raw }};
                    var _view   = {{ this.view|json_encode|raw }};

                    function loadApexOnce() {
                        if (window.ApexCharts) return Promise.resolve();
                        if (window.__apexLoading) return window.__apexLoading;
                        window.__apexLoading = new Promise(function (resolve, reject) {
                            var s = document.createElement('script');
                            s.src = "https://cdn.jsdelivr.net/npm/apexcharts";
                            s.async = true;
                            s.onload = resolve;
                            s.onerror = function(){ reject(new Error("apex_load_failed")); };
                            document.head.appendChild(s);
                        });
                        return window.__apexLoading;
                    }

                    function render() {
                        var el = document.getElementById(_id);
                        if (!el || el.dataset.rendered === "1") return;

                        var isPct = (_view === 'pct');

                        var options = {
                            chart: {
                                type: "bar",
                                height: _height,
                                parentHeightOffset: 0,
                                fontFamily: 'inherit',
                                toolbar: { show: false },
                                animations: { enabled: false }
                            },
                            plotOptions: {
                                bar: { horizontal: false, columnWidth: "55%", borderRadius: 2 }
                            },
                            dataLabels: { enabled: false },
                            grid: { strokeDashArray: 4, padding: { top: -10, right: 0, left: -4, bottom: -4 } },
                            xaxis: { categories: _labels, tooltip: { enabled: false } },
                            yaxis: {
                                labels: {
                                    formatter: function (val) {
                                        return isPct ? (Math.round(val * 10) / 10) + '%' : val;
                                    }
                                }
                            },
                            tooltip: {
                                shared: true,
                                intersect: false,
                                y: {
                                    formatter: function (val) {
                                        return isPct ? (Math.round(val * 10) / 10) + '%' : val;
                                    }
                                }
                            },
                            legend: {
                                show: true,
                                position: 'bottom',
                                offsetY: 8,
                                markers: { width: 10, height: 10, radius: 100 },
                                itemMargin: { horizontal: 8, vertical: 8 }
                            },
                            series: _series
                        };

                        loadApexOnce().then(function(){
                            var chart = new ApexCharts(el, options);
                            chart.render();
                            el.dataset.rendered = "1";
                            el.__chart = chart;
                        });
                    }

                    if (window.Turbo) {
                        document.addEventListener('turbo:load', render, { once: true });
                    } else if (document.readyState === 'complete' || document.readyState === 'interactive') {
                        render();
                    } else {
                        document.addEventListener('DOMContentLoaded', render, { once: true });
                    }
                })();
            </script>
        {% endif %}
    </div>
</div>
